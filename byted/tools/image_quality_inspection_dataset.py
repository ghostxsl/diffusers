# Copyright (c) wilson.xu. All rights reserved.
import argparse
import json

from tqdm import tqdm
from diffusers.data.utils import load_csv_or_xlsx_to_dict, json_save, load_file
from diffusers.data.byted.clients.azure_mllm import MLLMClient


sys_prompt = "You are a professional quality inspector for AIGC-generated images and also a world-class artificial intelligence art director. Your task is to provide your evaluation result and reasons based on the given image and the following requirements (your answer should be in JSON format)."
prompt = """This is a product poster image generated by a large AIGC model. You need to conduct a quality inspection on the image in accordance with the following task requirements and provide your evaluation result and reasons.
Task Requirements:
1. Copywriting Spelling Errors: For the product name, primary selling points, and secondary selling points entered by the user, you need to locate their corresponding positions in the image and check whether the corresponding text in the image contains errors such as misspellings, missing characters, or repeated spellings. There is no need to pay attention to capitalization. Example: Rendered incorrectly: 'Super-Sof' is truncated (missing 't') and 'Fabric' is duplicated ('Fabric, Fabric,'), so there are spelling/duplication errors.
2. Copywriting Vertical Arrangement Errors: Check whether the text rendered in the image has a vertically arranged layout, it refers to a paragraph of text rotated 90 degrees clockwise or counterclockwise. Only need to focus on the text arranged vertically; other arrangement methods do not require attention.
3. Excessive Text Rendering Error Check: Check whether there is any content in the image other than the text entered by the user; only focus on the text rendering outside the product.
4. Defect Existence Errors: Check whether there are defects in the image. Example: Defects on characters' hands/feet, etc.
5. If any of the above errors exist, answer "False" along with the reasons; otherwise, answer "True" to indicate that the image has passed the quality inspection. No need to provide reasons when the answer is True.
6. The copywriting inspection (Spelling Errors and Vertical Arrangement Errors) should not include the original text inherent to the object itself, such as the printed text on cans, the usage instructions on hand cream, the label text on the perfume bottle, and so on.
7. The answer should be in JSON format.

Quality Inspection Example:
{
'overall_evaluation_result': False,
'product_name': {'checking_result':'True', 'reason':''},
'primary_selling_points': {'checking_result':'True', 'reason':''},
'secondary_selling_points': {'checking_result':'False', 'reason':'Each secondary selling point is repeated on the poster (appears twice) instead of only once.'},
'defect_existence': {'checking_result':'False', 'reason':'There are defects on the model\'s hands in the image'}
'vertical_arrangement_errors':{'checking_result':'False', 'reason':'\"Refined Leather Craftsmanship\" is arranged vertically on the right side of the image.'},
'unexpected_generation': {'checking_result':'False', 'reason':'There is additional text \"headline\" appearing in the image.'}
}

Below is the product name, primary selling points, and secondary selling points:
"""


def parse_args():
    parser = argparse.ArgumentParser(description="inference script.")
    parser.add_argument(
        "--input_file",
        default=None,
        type=str,
        help="Path to image list on vos.")
    parser.add_argument(
        "--output_file",
        default="output.json",
        type=str,
        help="Path to image list on vos.")

    parser.add_argument(
        "--rank",
        default=None,
        type=int)
    parser.add_argument(
        "--num_ranks",
        default=None,
        type=int)

    args = parser.parse_args()

    return args


def _format_prompt_string(input_str):
    try:
        input_str = eval(input_str)
    except:
        input_str = input_str

    if isinstance(input_str, str):
        return f"\"{input_str}\""
    elif isinstance(input_str, list):
        input_str = [f"\"{a}\"" for a in input_str]
        return ", ".join(input_str)
    else:
        return ""


def main(args):
    gpt_client = MLLMClient(model_name="gpt-5-mini-2025-08-07")
    try:
        info_dict = load_csv_or_xlsx_to_dict(args.input_file)
    except:
        info_dict = load_file(args.input_file)

    if args.rank is not None and args.num_ranks is not None:
        assert args.rank < args.num_ranks

        info_dict = info_dict[args.rank::args.num_ranks]

    for item in tqdm(info_dict):
        try:
            input_text = {
                "product_name": _format_prompt_string(item['text_product_names']),
                "primary_selling_points": _format_prompt_string(item['text_primary_selling_points']),
                "secondary_selling_points": _format_prompt_string(item['text_secondary_selling_points']),
            }
            input_text = json.dumps(input_text)
            result_prompt = gpt_client.make_image_request(
                sys_prompt,
                prompt + input_text,
                image_urls=[item['gen_url']],
                max_tokens=6000,
            )
            item['predict_result'] = result_prompt
        except Exception as e:
            print(item, e)

    json_save(info_dict, args.output_file)


if __name__ == "__main__":
    args = parse_args()
    main(args)
    print('Done!')
